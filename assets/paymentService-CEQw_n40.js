var P=Object.defineProperty;var v=(i,e,r)=>e in i?P(i,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):i[e]=r;var g=(i,e,r)=>v(i,typeof e!="symbol"?e+"":e,r);import{x as I}from"./index-BnT946GU.js";import{p as d}from"./promoCodeService-8OR0XIRB.js";import{b as w}from"./balanceService-BrshoRSL.js";class M{constructor(){g(this,"prices",{monthly:7.99,annual:59.99})}async processPayment(e,r,t,s){try{const o=this.prices[e];let l=o,a,c;if(t&&s){const u=await d.validatePromoCode(t,e==="monthly"?"Monthly":"Annual",s);u.isValid&&u.promoDetails&&(l=this.calculateDiscountedPrice(o,u.promoDetails),a=u.promoDetails,c=u.promoDetails.id)}if(!this.validatePaymentDetails(r))return{success:!1,error:"Invalid payment details"};const p=`pay_${Math.random().toString(36).substring(2,15)}`,f=new Date,n=new Date(f);e==="monthly"?n.setMonth(n.getMonth()+1):n.setFullYear(n.getFullYear()+1),a&&a.discountType==="free"&&a.duration==="days"&&a.durationValue&&n.setDate(n.getDate()+a.durationValue);const y={plan:e,startDate:f,endDate:n,autoRenew:!0,status:"pending",paymentId:p,promoCodeId:c,originalPrice:o,finalPrice:l},b=Math.round(l*15e3),D=s||this.getTempUserId(),S=`Subscription to ${e==="monthly"?"Monthly":"Annual"} Plan`,h=await w.deductBalance(D,b,S,r.method);if(!h.success)return{success:!1,error:h.error||"Payment failed"};y.status="active";const m={success:!0,paymentId:p,subscriptionDetails:y,promoCodeApplied:!!c,promoCode:a};return m.success&&s&&c&&await d.recordPromoCodeUsage(c,s,m.paymentId||""),m}catch(o){return console.error("Payment processing error:",o),{success:!1,error:o instanceof Error?o.message:"Unknown payment error"}}}async verifyPayment(e){try{return await new Promise(r=>{const t=3e3+Math.random()*2e3;setTimeout(()=>{const s=Math.random()<.8;r(s)},t)})}catch(r){return console.error("Payment verification error:",r),!1}}async calculatePrice(e,r,t){const s=this.prices[e];if(!r||!t)return s;const o=await d.validatePromoCode(r,e==="monthly"?"Monthly":"Annual",t);return o.isValid&&o.promoDetails?this.calculateDiscountedPrice(s,o.promoDetails):s}calculateDiscountedPrice(e,r){if(!r)return e;if(r.discountType==="free")return 0;if(r.discountType==="percentage"){const t=e*r.discountValue/100;return Math.max(0,e-t)}return r.discountType==="fixed"?Math.max(0,e-r.discountValue):e}async saveSubscription(e,r){try{const t=localStorage.getItem("user");if(!t)return!1;const s=JSON.parse(t);return s.subscription=r,s.isPremium=r.status==="active",localStorage.setItem("user",JSON.stringify(s)),!0}catch(t){return console.error("Error saving subscription:",t),!1}}async cancelSubscription(e){try{const r=localStorage.getItem("user");if(!r)return!1;const t=JSON.parse(r);if(t.subscription){const s={...t.subscription};return t.subscription.status="canceled",t.subscription.autoRenew=!1,localStorage.setItem("user",JSON.stringify(t)),s.promoCodeId,this.offerWinbackPromoCode(e),!0}return!1}catch(r){return console.error("Error canceling subscription:",r),!1}}async offerWinbackPromoCode(e){try{I({title:"Special Offer",description:"Use code BREATHEAGAIN for 1 month free when you resubscribe!"})}catch(r){console.error("Error offering win-back promo code:",r)}}hasActiveSubscription(e){var r;try{const t=localStorage.getItem("user");if(!t)return!1;const s=JSON.parse(t);return s.isPremium===!0&&((r=s.subscription)==null?void 0:r.status)==="active"&&new Date(s.subscription.endDate)>new Date}catch(t){return console.error("Error checking subscription:",t),!1}}getSubscriptionDetails(e){try{const r=localStorage.getItem("user");return r&&JSON.parse(r).subscription||null}catch(r){return console.error("Error getting subscription details:",r),null}}getTempUserId(){let e=localStorage.getItem("temp_user_id");return e||(e=`temp_user_${Date.now()}`,localStorage.setItem("temp_user_id",e)),e}validatePaymentDetails(e){return e.method==="credit_card"?!!(e.cardNumber&&e.cardExpiry&&e.cardCVC):e.method==="apple_pay"||e.method==="google_pay"||e.method==="balance"}}const N=new M;export{N as p};
//# sourceMappingURL=paymentService-CEQw_n40.js.map
